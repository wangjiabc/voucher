<!DOCTYPE html>
<html>
<head>
<title>安全隐患详情</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection" content="telephone=no" />
<meta charset="utf-8" />
 <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
    <link rel="stylesheet" href="../css/weui.css"/>
    <link rel="stylesheet" href="../css/example.css"/>
<style type="text/css">
    body, html,#allmap {width: 100%;height: 70%;margin:0;font-family:"微软雅黑";}
</style>
<script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=cR98TwX2FnKTpANIOYhMYMot9a4ioxjc"></script>
</head>

<body>
  <form action="" novalidate>
    <div class="weui-cells weui-cells_form">
            <div class="weui-cell">
                <div class="weui-cell__hd"><label class="weui-label">隐患名称</label></div>
                <div id="name" class="weui-cell__bd">
                </div>
            </div>
    </div>
    <div class="weui-cells weui-cells_form">
        <div class="weui-cell">
                <div class="weui-cell__hd"><label class="weui-label">隐患等级</label></div>
                <div id="level" class="weui-cell__bd">
                </div>
               
        </div>
    </div>
    
    
     <div class="weui-cells weui-cells_form">
      <div class="weui-cell">
             <div class="weui-cell__hd"><label class="weui-label">整改状态</label></div>
                <div id="progress" class="weui-cell__bd">
                </div>
            <div id="progress_img" class="weui-cell weui-cell_warn">                  
            </div>
         </div>
    </div>
    
    <div class="weui-cells weui-cells_form">
        <div class="weui-cell">
                <div class="weui-cell__hd"><label class="weui-label">发生时间</label></div>
                <div id="happenTime" class="weui-cell__bd">
                </div>
        </div>
    </div>
    
    <div class="weui-cells weui-cells_form">
        <div class="weui-cell">
                <div class="weui-cell__hd"><label class="weui-label">录入时间</label></div>
                <div id="insertTime" class="weui-cell__bd">
                </div>
        </div>
    </div>
   
     <div class="weui-cells weui-cells_form">
            <div class="weui-cell">
                <div class="weui-cell__hd"><label class="weui-label">备注</label></div>
                <div id="remark" class="weui-cell__bd">
                </div>
            </div>
    </div>
    
    <div class="weui-cells__title">隐患详情</div>
        <div class="weui-cells weui-cells_form">
            <div class="weui-cell">
                <div id="detail" class="weui-cell__bd">
                </div>
            </div>
        </div>
  
  </form>
  
    <div id="allmap"></div>   
    <div class="weui-cells__title">隐患图片</div>    
    <div id="img" class="weui_grids"></div>
        
</body>
</html>
<script type="text/javascript">
  function getQueryString(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
    var r = window.location.search.substr(1).match(reg);
    if (r != null) return unescape(r[2]); return null;
   }

  var guid=getQueryString("guid");

    // 百度地图API功能
    var map = new BMap.Map("allmap");    // 创建Map实例

  //配置搜索
	var local = new BMap.LocalSearch(map,       
		{renderOptions: {map: map,autoViewport: false},pageCapacity: 1}      
	); 
	
	// 定义一个控件类,即function
	function ZoomControl(){
	  // 默认停靠位置和偏移量
	  this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
	  this.defaultOffset = new BMap.Size(200, 20);
	}

	// 通过JavaScript的prototype属性继承于BMap.Control
	ZoomControl.prototype = new BMap.Control();

	// 自定义控件必须实现自己的initialize方法,并且将控件的DOM元素返回
	// 在本方法中创建个div元素作为控件的容器,并将其添加到地图容器中
	ZoomControl.prototype.initialize = function(map){
	  // 创建一个DOM元素
	  var div = document.createElement("div");
	  // 添加文字说明
	  var input=document.createElement("input");
	  input.setAttribute("id","input");
	  div.appendChild(input);
	  // 设置样式
	  div.style.cursor = "pointer";
	  div.style.border = "1px solid gray";
	  div.style.backgroundColor = "white";
	  // 绑定事件,点击一次放大两级
	  input.onkeydown = keyDown;  
	  // 添加DOM元素到地图中
	  map.getContainer().appendChild(div);
	  // 将DOM元素返回
	  return div;
	}
	// 创建控件
	var myZoomCtrl = new ZoomControl();
	// 添加到地图当中
	map.addControl(myZoomCtrl);
	
	function keyDown(e) {   		  
	　   var keycode = e.which;   //取得对应的键值（数字）  	  
	　   var realkey = String.fromCharCode(e.which); //取得代表改键的真正字符  
	   var val = document.getElementById("input").value;
	　   if(keycode==13){
		   local.search(val);
	　   }
	 }     
    
	$.ajax({
        type: "POST",
        url: "/voucher/mobile/hidden/selectHiddenByGuid.do",
        data: { "guid":guid},
        dataType: "json",
        error: function (request){
     	   console.log(request);
        },
        success: function (text) {              	   
     	   var obj=text.hidden;
     	   var imgs=text.fileBytes;
  
             	   var guid=obj.guid;
  
             	   var distance=null;
             	   console.log(obj.name+"   "+obj.detail+"  "+obj.lng+"   "+obj.lat);
             	   if(obj.lng!=""&&obj.lat!=""){
             	   	  distance=getDistance(obj.lng,obj.lat);
             	   	var point = new BMap.Point(obj.lng,obj.lat);
             	    map.centerAndZoom(point, 12);
             	    var marker = new BMap.Marker(point); // 创建点
             		map.addOverlay(marker);    //增加点
             	   }
             	   
             	  var name=document.createElement("span");
                  name.innerHTML=obj.name;
                  $("#name").append(name);
                  
                  var level=document.createElement("span");
                  level.innerHTML=obj.level_text;
                  $("#level").append(level);
                  
                  var progre=obj.progress;
                  var type;
                  var progress_img=document.createElement("i");
                  
                  if(progre==0){
                	  type="未整改";
                	  progress_img.setAttribute("class","weui-icon-warn");
                  }else if(progre>0&&progre<1){
                	  type="整改中";
                	  progress_img.setAttribute("class","weui-icon-info-circle");  
                  }else if(progre==1){
                	  type="已整改";
                	  progress_img.setAttribute("class","weui-icon-success");
                  }
                  $("#progress_img").append(progress_img);
                  var progress=document.createElement("span");
                  progress.innerHTML=type;
                  $("#progress").append(progress);

                  
                  var time=actionTime(obj.happen_time);
                  var happenTime=document.createElement("span");
                  happenTime.innerHTML=time;
                  $("#happenTime").append(happenTime);
                  
                  var time=actionTime(obj.date);
                  var insertTime=document.createElement("span");
                  insertTime.innerHTML=time;
                  $("#insertTime").append(insertTime);
                  
                  var remark=document.createElement("span");
                  remark.innerHTML=obj.remark;
                  $("#remark").append(remark);
                  
                  var detail=document.createElement("textarea");
                  detail.setAttribute("class","weui-textarea");
                  detail.innerHTML=obj.detail;
                  $("#detail").append(detail);
                  
                  console.log(imgs);
            	   if(imgs!=null){
                    	   var i = 0;
                           for(; i < imgs.length; i++){
                          	 var a=document.createElement("a");
                         	  a.setAttribute("class","weui_grid");
                         	  var div=document.createElement("div");
                         	  div.setAttribute("class","weui_grid_icon");
                         	  
                    	   	  src="/voucher/"+imgs[i];
                    	  	  var img=document.createElement("img");
                              img.setAttribute("src",src);
                           	  img.setAttribute("width","300");
                           	  img.setAttribute("height","auto");
                            
                           	  div.appendChild(img);
                           	  a.appendChild(div);
                    	      $("#img").append(a);
                           }
            		   
            	   }
        }
    });
    
    
	
	
	function actionTime(value){
  	    var date = new Date(value); 
  	    Y = date.getFullYear() + '年';
  	    M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '月';
  	    D = date.getDate() + '日 ';
  	    h = date.getHours() + ':';
  	    m = date.getMinutes() + ':';
  	    s = date.getSeconds(); 
  		return Y+M+D;
  	}
	
	
	
    var xhm=new XMLHttpRequest();
    xhm.open("GET","../../../baiduMap/location.do",false);
    xhm.setRequestHeader("Content-type","application/x-www-form-urlencoded");
    xhm.send();
    var ticket=JSON.parse(xhm.responseText);
    var longitude=ticket.content.point.x;
    var latitude=ticket.content.point.y;
    var point = new BMap.Point(longitude, latitude);

	var str = "我的位置";
	var opts = {
			   position : point,    // 指定文本标注所在的地理位置
			   offset   : new BMap.Size(-getByteLen(str)*3, 5)    //设置文本偏移量
			}	
	var label = new BMap.Label(str, opts);  // 创建文本标注对象
	label.setStyle({
					 fontSize : "12px",
					 height : "20px",
					 lineHeight : "20px",
					 fontFamily:"微软雅黑"
				  });
    map.addOverlay(label);   
    
    
    function getByteLen(val) {    //传入一个字符串
        var len = 0;
        for (var i = 0; i < val.length; i++) {
            if (val[i].match(/[^\x00-\xff]/ig) != null) //全角 
                len += 2; //如果是全角，占用两个字节  如果mysql中某字段是text, 如果设置编码为utf-8,那么一个中文是占3个字节, gbk是两个字节
            else
                len += 1; //半角占用一个字节
        }
        return len;
     }  
    
    function getDistance(lng,lat){
    	var pointA = new BMap.Point(longitude,latitude);  // 创建点坐标A--大渡口区
    	var pointB = new BMap.Point(lng,lat);  // 创建点坐标B--江北区
    	var d=map.getDistance(pointA,pointB)/1000;
    	return d.toFixed(2)+' KM';  //获取两点距离,保留小数点后两位
    }
    
</script>